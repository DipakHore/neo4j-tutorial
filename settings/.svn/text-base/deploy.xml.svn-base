<?xml version="1.0" ?>
<project name="deploy" default="donothingToMakeAValidAntFile" basedir=".">
	<target name="donothingToMakeAValidAntFile" />


	<macrodef name="deploygridmanager" description="Installs grid-manager rpms on the performance-test host and starts it">
		<attribute name="host" default="amardev01.spinvox.lan" />
		<attribute name="user" default="java-builder" />
		<attribute name="password" default="v00dk4" />
		<attribute name="topology.properties" />
		<attribute name="language.properties" />

		<sequential>
			<echo message="Stopping grid manager and removing any existing installations" />
			<sshexec host="@{host}" username="@{user}" password="@{password}" trust="true" command="sudo yum -y remove sv-java-gridmanager sv-java-gridmanager-etc" failonerror="false" />

			<echo message="Installing Grid Manager rpms on @{host}" />
			<sshexec host="@{host}" username="@{user}" password="@{password}" trust="true" command="sudo yum clean all; sudo yum -y install sv-java-gridmanager sv-java-gridmanager-etc" failonerror="true" />
			<echo message="Copying property files" />
			<scp trust="true" file="@{topology.properties}" todir="spinvox:5p1nv0x@@@{host}:/etc/spinvox/grid-manager" />
			<scp trust="true" file="@{language.properties}" todir="spinvox:5p1nv0x@@@{host}:/etc/spinvox/grid-manager" />
		</sequential>
	</macrodef>

	<macrodef name="startgridmanager" description="start real grid-manager">
		<attribute name="host" default="amardev01.spinvox.lan" />
		<attribute name="user" default="java-builder" />
		<attribute name="password" default="v00dk4" />
		<sequential>
			<echo message="Starting grid manager on @{host}" />
			<sshexec host="@{host}" username="@{user}" password="@{password}" trust="true" command="sudo /etc/init.d/gridmanager restart" />

			<echo message="Waiting for isAlive confirmation from Grid Manager before proceeding" />
			<waitfor maxwait="1" maxwaitunit="minute" checkevery="1" checkeveryunit="second">
				<http url="http://@{host}:8181/gridmanager/isAlive" />
			</waitfor>
			<echo message="grid manager now running on @{host}" />
		</sequential>
	</macrodef>
	
	<macrodef name="deploygridmanagerstartupscript" description="deploy gridmanager startup script">
		<attribute name="host" default="amardev01.spinvox.lan" />
		<attribute name="user" default="java-builder" />
		<attribute name="password" default="v00dk4" />
		
		<sequential>
			<echo message="copying startup script" />
			<scp trust="true" file="target/artifacts/grid-manager-typicaldaytest.jar" todir="spinvox:5p1nv0x@@@{host}:/opt/spinvox/grid-manager/grid-manager-typicaldaytest.jar" />
			<scp trust="true" file="tools/manager-typicalday.sh" todir="spinvox:5p1nv0x@@@{host}:/opt/spinvox/grid-manager/manager.sh" />
		</sequential>
	</macrodef>


	<macrodef name="undeploygridmanager" description="Installs grid-manager rpms on the performance-test host and starts it">
		<attribute name="host" default="amardev01.spinvox.lan" />
		<attribute name="user" default="java-builder" />
		<attribute name="password" default="v00dk4" />

		<sequential>
			<sshexec host="@{host}" username="@{user}" password="@{password}" trust="true" command="sudo /etc/init.d/gridmanager stop" />
			<sshexec host="@{host}" username="@{user}" password="@{password}" trust="true" command="sudo yum -y remove sv-java-gridmanager sv-java-gridmanager-etc" />
		</sequential>
	</macrodef>
</project>